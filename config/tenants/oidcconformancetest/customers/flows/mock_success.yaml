description: 'Implements a device-based login flow that checks for known devices and creates a mock user if needed'
start: init
nodes:
  init:
    name: init
    use: init
    custom_config: {}
    next:
      start: checkKnownDevice

  checkKnownDevice:
    name: checkKnownDevice
    use: isKnownDevice
    custom_config:
      cookie_name: device
    next:
      known_device: successResult
      unknown_device: askUserID
      oidc_requires_login: askUserID

  askUserID:
    name: askUserID
    use: askUserID
    custom_config: {}
    next:
      submitted: addKnownDevice
      not_found: setUsernameVariable

  setUsernameVariable:
    name: setUsernameVariable
    use: setVariable
    custom_config:
      key: username
      value: testuser
    next:
      done: setEmailVariable

  setEmailVariable:
    name: setEmailVariable
    use: setVariable
    custom_config:
      key: email
      value: testuser@example.com
    next:
      done: createUser

  createUser:
    name: createUser
    use: createUser
    next:
      success: addKnownDevice
      existing: addKnownDevice

  addKnownDevice:
    name: addKnownDevice
    use: addKnownDevice
    custom_config:
      cookie_name: device
    next:
      success: successResult
      device_already_exists: successResult

  successResult:
    name: successResult
    use: successResult
    custom_config:
      message: Device login successful!
    next: {}

